services:
  liferay:
    image: ${LIFERAY_IMAGE:-liferay/dxp:2025.q1.17-lts}
    container_name: liferay-dev
    restart: unless-stopped
    stop_grace_period: 120s
    environment:
      LIFERAY_JPDA_ENABLED: "true"
      LIFERAY_JVM_OPTS: "-Xms4g -Xmx4g"
      LIFERAY_CONTAINER_STATUS_ENABLED: "true"
      # JDBC connection for fresh Postgres
      LIFERAY_JDBC_PERIOD_DEFAULT_URL: "jdbc:postgresql://postgres:5432/${POSTGRES_DB:-liferay}"
      LIFERAY_JDBC_PERIOD_DEFAULT_USERNAME: "${POSTGRES_USER:-liferay}"
      LIFERAY_JDBC_PERIOD_DEFAULT_PASSWORD: "${POSTGRES_PASSWORD:-liferay}"
    ports:
      - "${LIFERAY_HTTP_PORT:-8080}:8080"   # HTTP
      - "${LIFERAY_DEBUG_PORT:-8000}:8000"  # Debug
      - "${LIFERAY_GOGO_PORT:-11311}:11311" # Gogo shell
    volumes:
      - ./liferay/scripts:/usr/local/liferay/scripts
      - ./liferay/build/docker/configs/dockerenv:/mnt/liferay/files
      - ./liferay/build/docker/deploy:/mnt/liferay/deploy
      - liferay-data:/opt/liferay/data
      - liferay-osgi-state:/opt/liferay/osgi/state
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/c/portal/layout || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 40
      start_period: 120s
    networks:
      - liferay-network

  postgres:
    image: postgres:15-alpine
    container_name: liferay-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-liferay}
      POSTGRES_USER: ${POSTGRES_USER:-liferay}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-liferay}
    # Dev-optimized: prioritize speed over durability (data is disposable)
    command: >
      postgres
      -c shared_buffers=256MB
      -c work_mem=64MB
      -c maintenance_work_mem=256MB
      -c fsync=off
      -c synchronous_commit=off
      -c full_page_writes=off
      -c max_wal_size=2GB
      -c checkpoint_completion_target=0.9
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - liferay-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-liferay} -d ${POSTGRES_DB:-liferay}"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  liferay-network:
    driver: bridge

volumes:
  postgres-data:
  liferay-data:
  liferay-osgi-state:
